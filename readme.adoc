= Clean Architecture
:imagesdir: ./images
:doctype: book

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

image::clean_architecture.png[]
== Les bases de cette architecture

La logique que vous implémentez doit :

* Être indépendante des frameworks : les frameworks et librairies doivent être des outils, sans pour autant vous contraindre.
* Être testable indépendamment : les tests doivent pouvoir être réalisés sans éléments externes (interface utilisateur, base de données ...)
* Être indépendante de l’interface utilisateur : l’interface utilisateur doit pouvoir changer de forme (console, interface web ...)
* Être indépendante de la base de données : il doit être possible de changer de SGBD.
* Être indépendante de tout service ou système externe : en résumé, elle ne doit pas avoir conscience de ce qui l’entoure.

== Définition de la structure du projet

.Steps
. Application : la partie des appels extérieurs
. Business : La partie métier
. Infrastructure : la partie de communication avec les infrastructures de l'entreprise
. Architecture : module qui servira uniquement à mettre en place les règles de contrôle du projet

== Mise en place
[*Revoir le sujet*]

* Création d'un repository git
* Copier le projet exemple dans un repertoire local

== Description des packages pour chaques modules

== Business

=== Les règles

IMPORTANT: Le module **Business** doit-être complétement autonome link:../architecture/src/test/java/org/example/structure/architecture/CheckArchitectureBusinessTest.java[contrôle]

image::business/dia_dep_business.png[]

=== Packages

.Composition du module
[options="header,footer"]
|=======================
|   Package    |      implèmentation      | Description
|   services   |  interface adapters.in   | Contient les cases d'usages
|    rules     |                          | Ensemble de régles qui seront utilisées uniquement dans `services`
|    models    |                          | Les classes de données
| adapters.in  |                          | Interfaces pour les cases d'usages
| adapters.out |                          | Interfaces pour le module `infrastructure`
|=======================

=== Représentation d'un cas
Nous allons développer l'usage suivant :
Rechercher une personne depuis son id en utilisant un service REST qui dans l'infrastructure de l'entreprise
Cet usage ajoutera la civilité et calculera le nombre de jours depuis sa date de naissance

image::business/dia_business_ex.png[]

Le déroulement des différents appels sont sous la forme suivante :

image::business/dia_seq_business_ex.png[]

CAUTION: Pour l'instant l'interface *RestPersonneOut*, ne nous permet pas de savor ce qu'il se cache derrier la méthode *__Personne findById(id String)__*. +
On peut se poser la question : Est-ce vraiment important !!



== Infrastructure

=== Les règles

IMPORTANT: Le module **Infrastructure** ne doit avoir uniquement les dépendences suivantes +
implementer une interface du module **Business** du package `adapters.out` +
avec les models module **Business**

image::infrastructure/dia_dep_infrastructure.png[]

=== Packages

. Composition du module
[options="header,footer"]
|=======================
|       Package       |     implèmentation     | Description
|      services       | interface adapters.out | Usages définis dans le module **Business**
|     repository      |                        | Les appels DB
| repository.entities |                        | Les classes de données pour la DB
|  repository.mapper  |                        | Convertisseurs entities/DB -> model de **business**
|        soap         |                        | Les appels en SOAP
|    soap.entities    |                        | Les classes de données pour les appels en SOAP
|     soap.mapper     |                        | Convertisseurs entities/SOAP -> model de **business**
|        rest         |                        | Les appels REST
|    rest.entities    |                        | Les classes de données pour les appels en REST
|     rest.mapper     |                        | Convertisseurs entities/REST -> model de **business**
|=======================

=== Représentation d'un cas
Nous devons développer un service REST qui doit interroger un service du réseau interne
afin de rechercher une personne depuis son id.
Voici la définition des différents éléments dans les modules **business** et **infrastructure** +

image::infrastructure/dia_infrastructure_ex.png[]

Le déroulement des différents appels sont sous la forme suivante : +

image::infrastructure/dia_seq_infrastructure_ex.png[]

== Application
=== Les règles

[IMPORTANT]
===============================
Le module **Application** aura les dépendences suivantes
    module **Business** :
[square]
* les models
    * Les interfaces `adapters.out` et `adapters.in`
    * Les services

module **Infrastructure** :
[square]
    * Les services
===============================

image::application/dia_dep_appli.png[]

=== Packages

Composition du module
[options="header,footer"]
|=======================
|       Package       |     implèmentation     | Description
| controllers|| les controleurs de l'application
| services|| Les services qui utiliseront un ou plusieurs services soit du module **business** ou **infrastructure**
|Dtos|| Classes de données
|mapper|| Convertisseurs dto <- -> models(_business_) ou  dto <- -> entitie(_infrastructure_)
|=======================

=== Représentation d'un cas

Développement du service mise à disposition d'un front ou autre, avec l'exemple de rechercher une personne depuis un id

image::application/dia_application_ex.png[]

=======================
=======================

== Le Développement
Pour le développement d'une application avec clean architecture,
il faut respecter plusieurs règles.
Ces règles seront en partie contrôlées par la librairie https://www.archunit.org/userguide/html/000_Index.html[ArchUnit]
Ce qui explique la présence du module `Architecture`

=== Case d'usage :
Le sujet sera un magasin, les points qui seront abordés :

[NOTE]
===============================
La liste ci-dessous sera amener à évoluer
===============================
===============================
[quote]
Les bornes d'information, au passage du code du produit pour avoir
[square]
    - le prix du produit Ttc
    - le nom
===============================
===============================
[quote]
Le passage en caisse, sur le tapis de la caisse un ensemble de produit
[square]
* passage du produit :
    - le nom, le prix Ttc
* Ajout dans la liste des produits déjà passés
* Suppression d'un article de la liste des produits
* liste des produits avec le detail
* nombre d'articles , le montant total Ttc
* la liste des articles : code produit, nom, prix Ttc
===============================

